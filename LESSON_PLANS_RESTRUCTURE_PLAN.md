# Lesson Plans Restructure Plan - Hybrid Approach

## Overview

This plan restructures the lesson plans from a single large JSON file (1.68 MB, 14,454 lines) into individual lesson files with a build system. This will eliminate timeout issues, improve searchability, and make editing much faster.

## Current State

- **File:** `src/lessonPlansData.json`
- **Size:** 1.68 MB
- **Lines:** 14,454
- **Structure:** Single JSON file with `{ lessonPlans: [...] }` array
- **Issues:** 
  - Timeout errors when inserting/editing
  - OOM (Out of Memory) issues
  - Slow search operations
  - Difficult to edit individual lessons

## Target State

### Directory Structure
```
src/
  lessonPlans/
    lessons/              # Individual lesson files
      LP-I-A.json
      LP-I-B.json
      LP-I-C.json
      ...
      LP-VII-A.json
      LP-VII-B.json
      ...
    metadata/             # Quick access metadata
      index.json          # All lesson IDs, titles, areas (lightweight)
      byArea.json         # Lessons grouped by area (for filtering)
    lessonPlansData.json  # Combined file (generated by build script)
    build.js              # Build script to combine lessons
    search.js             # Helper script for searching
```

### File Sizes (Estimated)
- Individual lesson files: ~50-150 KB each
- Index file: ~50-100 KB (metadata only)
- Combined file: ~1.68 MB (same as current, but generated)

## Implementation Steps

### Phase 1: Setup Directory Structure
1. Create `src/lessonPlans/lessons/` directory
2. Create `src/lessonPlans/metadata/` directory
3. Keep existing `src/lessonPlansData.json` as backup

### Phase 2: Create Migration Script
**File:** `scripts/migrate-lesson-plans.js`

**Purpose:** Split existing `lessonPlansData.json` into individual files

**Process:**
1. Read `src/lessonPlansData.json`
2. For each lesson in the array:
   - Extract lesson object
   - Create filename: `{lesson.id}.json` (e.g., `LP-VII-A.json`)
   - Write to `src/lessonPlans/lessons/{filename}`
3. Generate metadata files:
   - `index.json`: Array of `{ id, title, areaNumber, taskLetter, estimatedTime }`
   - `byArea.json`: Object with area numbers as keys, arrays of lesson IDs as values
4. Verify: Count files created, validate JSON structure

**Output:**
- ~85 individual lesson files in `src/lessonPlans/lessons/`
- 2 metadata files in `src/lessonPlans/metadata/`

### Phase 3: Create Build Script
**File:** `src/lessonPlans/build.js` or `scripts/build-lesson-plans.js`

**Purpose:** Combine individual lesson files into single JSON for app use

**Process:**
1. Read all JSON files from `src/lessonPlans/lessons/`
2. Parse each file
3. Sort by area number, then task letter
4. Combine into `{ lessonPlans: [...] }` structure
5. Write to `src/lessonPlansData.json`
6. Validate JSON structure
7. Report: Number of lessons combined, file size

**Usage:**
```bash
node scripts/build-lesson-plans.js
```

**Integration:**
- Add to `package.json` scripts: `"build:lessons": "node scripts/build-lesson-plans.js"`
- Optionally: Run automatically before `npm run build`

### Phase 4: Create Helper Scripts

#### 4a. Search Script
**File:** `scripts/search-lesson-plan.js`

**Purpose:** Fast search through lesson plans without loading full content

**Features:**
- Search by ID: `node scripts/search-lesson-plan.js LP-VII-A`
- Search by title: `node scripts/search-lesson-plan.js "Soft-Field"`
- Search by area: `node scripts/search-lesson-plan.js --area VII`
- List all: `node scripts/search-lesson-plan.js --list`
- Show metadata only (fast): `node scripts/search-lesson-plan.js LP-VII-A --metadata`

**Implementation:**
- Uses metadata/index.json for fast searches
- Only loads full lesson when needed

#### 4b. Edit Helper Script
**File:** `scripts/edit-lesson-plan.js`

**Purpose:** Open/edit specific lesson file easily

**Usage:**
```bash
node scripts/edit-lesson-plan.js LP-VII-A
# Opens LP-VII-A.json in default editor
```

#### 4c. Validation Script
**File:** `scripts/validate-lesson-plans.js`

**Purpose:** Validate all lesson files for structure and completeness

**Checks:**
- All required fields present
- Valid JSON structure
- IDs match filenames
- No duplicate IDs
- All lessons referenced in index

### Phase 5: Update App Code (Minimal Changes)

**Files to modify:**
1. `src/pages/LessonPlanDetail.tsx` - No changes needed (still imports combined file)
2. `src/pages/LessonPlansIndex.tsx` - Could optionally use metadata for faster loading
3. `src/pages/LessonPlansByArea.tsx` - Could optionally use byArea.json

**Note:** App continues to use `lessonPlansData.json` - no breaking changes!

**Optional Optimization:**
- Create a hook that loads metadata first, then loads full lesson on demand
- This would make initial page load faster

### Phase 6: Update Documentation

**Files:**
1. Update `README.md` with new structure
2. Create `LESSON_PLANS_EDITING_GUIDE.md`:
   - How to edit individual lessons
   - How to add new lessons
   - How to run build script
   - How to use helper scripts

### Phase 7: Testing & Validation

**Test Cases:**
1. Migration: Verify all 85 lessons migrated correctly
2. Build: Verify combined file matches original structure
3. App: Verify app still works with generated file
4. Search: Test search script with various queries
5. Edit: Test editing individual file and rebuilding

## Detailed File Specifications

### Individual Lesson File Format
**File:** `src/lessonPlans/lessons/LP-VII-A.json`

**Structure:** Single lesson object (no wrapper)
```json
{
  "id": "LP-VII-A",
  "areaNumber": "VII",
  "taskLetter": "A",
  "title": "Normal Takeoff and Climb",
  ...
}
```

### Metadata Index Format
**File:** `src/lessonPlans/metadata/index.json`

**Structure:**
```json
[
  {
    "id": "LP-VII-A",
    "title": "Normal Takeoff and Climb",
    "areaNumber": "VII",
    "taskLetter": "A",
    "estimatedTime": "1.0 hours (0.3 ground, 0.7 flight)"
  },
  ...
]
```

### By Area Format
**File:** `src/lessonPlans/metadata/byArea.json`

**Structure:**
```json
{
  "I": ["LP-I-A", "LP-I-B", "LP-I-C", ...],
  "II": ["LP-II-A", "LP-II-B", ...],
  "VII": ["LP-VII-A", "LP-VII-B", ...],
  ...
}
```

## Migration Script Details

### Script: `scripts/migrate-lesson-plans.js`

```javascript
const fs = require('fs');
const path = require('path');

const INPUT_FILE = 'src/lessonPlansData.json';
const LESSONS_DIR = 'src/lessonPlans/lessons';
const METADATA_DIR = 'src/lessonPlans/metadata';

// Read existing file
const data = JSON.parse(fs.readFileSync(INPUT_FILE, 'utf8'));
const lessons = data.lessonPlans;

// Create directories
fs.mkdirSync(LESSONS_DIR, { recursive: true });
fs.mkdirSync(METADATA_DIR, { recursive: true });

// Extract metadata
const index = [];
const byArea = {};

// Write individual files
lessons.forEach(lesson => {
  // Write lesson file
  const filename = `${lesson.id}.json`;
  fs.writeFileSync(
    path.join(LESSONS_DIR, filename),
    JSON.stringify(lesson, null, 2)
  );
  
  // Add to metadata
  index.push({
    id: lesson.id,
    title: lesson.title,
    areaNumber: lesson.areaNumber,
    taskLetter: lesson.taskLetter,
    estimatedTime: lesson.estimatedTime
  });
  
  // Add to byArea
  if (!byArea[lesson.areaNumber]) {
    byArea[lesson.areaNumber] = [];
  }
  byArea[lesson.areaNumber].push(lesson.id);
});

// Write metadata files
fs.writeFileSync(
  path.join(METADATA_DIR, 'index.json'),
  JSON.stringify(index, null, 2)
);

fs.writeFileSync(
  path.join(METADATA_DIR, 'byArea.json'),
  JSON.stringify(byArea, null, 2)
);

console.log(`‚úÖ Migrated ${lessons.length} lessons`);
console.log(`‚úÖ Created ${index.length} lesson files`);
console.log(`‚úÖ Created metadata files`);
```

## Build Script Details

### Script: `scripts/build-lesson-plans.js`

```javascript
const fs = require('fs');
const path = require('path');

const LESSONS_DIR = 'src/lessonPlans/lessons';
const OUTPUT_FILE = 'src/lessonPlansData.json';

// Read all lesson files
const files = fs.readdirSync(LESSONS_DIR)
  .filter(f => f.endsWith('.json'))
  .sort(); // Sort for consistent output

const lessons = files.map(file => {
  const content = fs.readFileSync(
    path.join(LESSONS_DIR, file),
    'utf8'
  );
  return JSON.parse(content);
});

// Sort by area number, then task letter
lessons.sort((a, b) => {
  if (a.areaNumber !== b.areaNumber) {
    return a.areaNumber.localeCompare(b.areaNumber);
  }
  return a.taskLetter.localeCompare(b.taskLetter);
});

// Write combined file
const output = { lessonPlans: lessons };
fs.writeFileSync(
  OUTPUT_FILE,
  JSON.stringify(output, null, 2)
);

console.log(`‚úÖ Built ${lessons.length} lessons into ${OUTPUT_FILE}`);
console.log(`üìä File size: ${(fs.statSync(OUTPUT_FILE).size / 1024 / 1024).toFixed(2)} MB`);
```

## Workflow After Migration

### Editing a Lesson
1. Edit `src/lessonPlans/lessons/LP-VII-A.json` directly
2. Run `npm run build:lessons` to regenerate combined file
3. App automatically uses updated file

### Adding a New Lesson
1. Create `src/lessonPlans/lessons/LP-VII-H.json` with lesson content
2. Run `npm run build:lessons`
3. Metadata files auto-updated by build script

### Searching Lessons
```bash
# Fast search (uses metadata)
node scripts/search-lesson-plan.js "Soft-Field"

# Full lesson details
node scripts/search-lesson-plan.js LP-VII-C --full
```

## Rollback Plan

If issues occur:
1. Original `lessonPlansData.json` is backed up
2. Simply restore the original file
3. App continues working (no code changes needed)

## Benefits Summary

‚úÖ **No More Timeouts**
- Individual files are small (~50-150 KB)
- Fast to edit and save

‚úÖ **Better Searchability**
- Grep individual files: `grep "VX" src/lessonPlans/lessons/LP-VII-*.json`
- Metadata file for fast lookups

‚úÖ **Easier Collaboration**
- Git diffs show only changed lessons
- Multiple people can edit different lessons simultaneously

‚úÖ **Better Performance**
- App can optionally lazy-load lessons
- Metadata loads instantly

‚úÖ **No Breaking Changes**
- App still uses combined file
- Existing code continues to work

## Estimated Time

- **Phase 1-2 (Setup & Migration):** 30 minutes
- **Phase 3 (Build Script):** 15 minutes
- **Phase 4 (Helper Scripts):** 30 minutes
- **Phase 5 (App Updates - Optional):** 15 minutes
- **Phase 6 (Documentation):** 15 minutes
- **Phase 7 (Testing):** 15 minutes

**Total:** ~2 hours

## Risk Assessment

**Low Risk:**
- Original file preserved as backup
- App code doesn't need changes
- Can rollback easily

**Mitigation:**
- Test migration on copy first
- Verify build output matches original
- Test app functionality after migration

## Next Steps After Approval

1. Create backup of current `lessonPlansData.json`
2. Run migration script
3. Verify all files created correctly
4. Test build script generates identical output
5. Test app still works
6. Update documentation
7. Commit changes

---

## Implementation Progress

### ‚úÖ Completed
- **Directory Structure Created** - `src/lessonPlans/lessons/` and `src/lessonPlans/metadata/` directories set up
- **Migration Scripts Created** - Multiple extraction scripts created (standard, robust, streaming, fixed)
- **Build Script Created** - `build-lesson-plans.js` successfully tested
- **Helper Scripts Created** - Search, validation scripts ready
- **Initial Migration** - 41 lessons successfully extracted from fixed JSON
- **Build System Tested** - Successfully rebuilt combined file (1.65 MB)

### ‚úÖ Completed (Updated)
- **JSON File Fixed** - Rebuilt from successfully extracted lessons
  - Used build script to regenerate `lessonPlansData.json` from 41 extracted lessons
  - File is now valid JSON (verified)
  - **Status:** Working with 41 extracted lessons; source file has errors but we have working extracted versions

### ‚è≥ Pending
- **Complete Migration** - Extract all lessons including C, D, G from Area VII
- **Validate All Lessons** - Ensure all extracted lessons are complete
- **Update Documentation** - Finalize editing guide

### üìä Current Status
- **Location:** `C:\Users\danrr\Desktop\CFI\App\cfi-acs-app-restructured`
- **Lessons Extracted:** 41 of ~85 expected
- **Area VII Lessons:** 5 extracted (A, B, E, F, N), missing C, D, G, H, I, J, K, L, M, O
- **JSON File:** Has syntax errors preventing complete extraction

### üîß Next Steps
1. **Fix JSON truncation** - Complete LP-V-C lesson structure (add missing closures)
2. **Re-run extraction** - Get all lessons including C, D, G from Area VII
3. **Verify extraction** - Ensure all 85+ lessons are extracted correctly
4. **Complete Area VII** - Create remaining lessons (H, I, J, K, L, M, O) directly as individual files

### üìù Notes
- **Working System:** Build system is functional - 41 lessons successfully extracted and rebuilt
- **File Issue:** Source JSON file is incomplete/truncated - needs manual fix or completion
- **Workaround:** Can continue creating new lessons as individual files, then build combined file
- **Recommendation:** Fix source file to complete migration, or work directly with individual files going forward

---

**Ready for Review:** Please review this plan and let me know if you'd like any modifications before I proceed with implementation.

